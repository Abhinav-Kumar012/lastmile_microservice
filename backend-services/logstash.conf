input {
  beats {
    port => 5044
  }
}

filter {
  #
  # 1. Parse JSON logs from Spring Boot (LogstashEncoder)
  #
  # Filebeat sends your entire log row in "message" field.
  # This converts that JSON string into structured fields.
  #
  json {
    source => "message"
    remove_field => ["message"]
  }

  #
  # 2. Extract service_name from Filebeat metadata
  #
  # Your Filebeat YAML sets:
  # fields:
  #   service_name: "your-service-name"
  #
  # AND also:
  # fields_under_root: true
  #
  # So the final field is simply:   service_name
  #
  #
  if ![service_name] and [fields][service_name] {
    mutate {
      rename => { "[fields][service_name]" => "service_name" }
    }
  }

  if ![service_name] {
    mutate {
      add_field => { "service_name" => "unknown-service" }
    }
  }

  #
  # 3. Ensure @timestamp uses the log's timestamp
  #
  # JSON logs from LogstashEncoder include `timestamp` or `@timestamp`.
  #
  if [timestamp] {
    date {
      match => ["timestamp", "ISO8601"]
      target => "@timestamp"
    }
    mutate {
      remove_field => ["timestamp"]
    }
  }

  #
  # Optional: normalize level field to lowercase
  #
  if [level] {
    mutate {
      lowercase => ["level"]
    }
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]

    # Final index format:
    #   logs-2025.11.20-user-service
    index => "logs-%{+YYYY.MM.dd}-%{service_name}"
  }

  # Optional: See parsed logs in Logstash console
  stdout { codec => rubydebug }
}
